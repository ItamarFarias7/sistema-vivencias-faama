require('dotenv').config(); // Carrega as variáveis de ambiente
const express = require('express');
const mysql = require('mysql2/promise');
const path = require('path');
const session = require('express-session');
// exceljs e pdfkit devem ser importados quando as rotas forem criadas

const app = express();
const PORT = process.env.PORT || 3000;
const LIMITE_POR_GRUPO = 10;
const SENHA_ADMIN = process.env.SENHA_ADMIN || 'faama2026';

app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.urlencoded({ extended: true }));
app.use(session({ 
    secret: process.env.SESSION_SECRET || 'chave_secreta_faama', 
    resave: false, 
    saveUninitialized: true 
}));

// Criação do POOL de conexões (Nível Impressionador de Performance!)
const pool = mysql.createPool({
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '@Itamar420',
    database: process.env.DB_NAME || 'faama_sorteio',
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0
});

// Middleware de Autenticação
function checkAuth(req, res, next) {
    if (req.session.logado) {
        next();
    } else {
        req.session.erroLogin = "Acesso negado. Faça login primeiro.";
        res.redirect('/');
    }
}

// === ROTAS DA APLICAÇÃO ===

// Portal Inicial
app.get('/', (req, res) => {
    const erro = req.session.erroLogin;
    req.session.erroLogin = null;
    res.render('portal', { erro });
});

// Tela do Aluno (Inscrição)
app.get('/aluno', async (req, res) => {
    try {
        // Usando o pool em vez de criar e fechar a conexão toda hora
        const [eixos] = await pool.execute('SELECT * FROM eixos');
        
        const erro = req.session.erro;
        req.session.erro = null; 
        res.render('index', { eixos, erro }); 
    } catch (error) {
        console.error("Erro banco de dados:", error);
        res.status(500).send("Erro interno no servidor.");
    }
});

// Processamento da Inscrição e Sorteio
app.post('/inscrever', async (req, res) => {
    const { nome, email, curso, turno, periodo, eixo_id } = req.body;

    try {
        const [grupos] = await pool.execute('SELECT id, nome FROM grupos WHERE eixo_id = ?', [eixo_id]);
        
        if (grupos.length === 0) {
            req.session.erro = "Nenhum grupo cadastrado neste eixo ainda.";
            return res.redirect('/aluno');
        }

        let gruposDisponiveis = [];

        for (let g of grupos) {
            const [totalCount] = await pool.execute('SELECT COUNT(*) as qtd FROM alunos WHERE grupo_id = ?', [g.id]);
            const totalAlunos = totalCount[0].qtd;

            // Só analisa grupos que ainda não bateram o limite de 10 pessoas
            if (totalAlunos < LIMITE_POR_GRUPO) {
                const [cursoCount] = await pool.execute(
                    'SELECT COUNT(*) as qtd FROM alunos WHERE grupo_id = ? AND curso = ?', 
                    [g.id, curso]
                );
                gruposDisponiveis.push({ id: g.id, nome: g.nome, total_curso: cursoCount[0].qtd });
            }
        }

        if (gruposDisponiveis.length === 0) {
            req.session.erro = "Todas as equipes deste eixo atingiram o limite!";
            return res.redirect('/aluno');
        }

        // Lógica de distribuição uniforme por curso
        const minCurso = Math.min(...gruposDisponiveis.map(g => g.total_curso));
        const gruposCandidatos = gruposDisponiveis.filter(g => g.total_curso === minCurso);
        const grupoSorteado = gruposCandidatos[Math.floor(Math.random() * gruposCandidatos.length)];

        await pool.execute(
            'INSERT INTO alunos (nome, email, curso, turno, periodo, grupo_id) VALUES (?, ?, ?, ?, ?, ?)',
            [nome, email, curso, turno, periodo, grupoSorteado.id]
        );

        res.render('resultado', { nome, grupo: grupoSorteado.nome });

    } catch (error) {
        console.error(error);
        req.session.erro = "Erro ao processar sua inscrição. Tente novamente.";
        res.redirect('/aluno');
    }
});

app.listen(PORT, () => {
    console.log(`Servidor rodando na porta http://localhost:${PORT}`);
});